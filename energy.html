<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendulum Energy Conservation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>
    <style>
        body { background-color: #0f172a; color: white; margin: 0; overflow: hidden; }
        .no-select { user-select: none; -webkit-user-select: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { Play, Pause, RotateCcw, Zap, Gauge, MousePointer2 } = lucide;

        // --- CONSTANTS ---
        const PIVOT_X = 0;
        const PIVOT_Y = 0;
        const PIXELS_PER_METER = 200; 
        const DT = 1/60; // Base time step

        const App = () => {
            // --- STATE ---
            // Simulation parameters
            const [length, setLength] = useState(1.5); // meters
            const [mass, setMass] = useState(2.0);     // kg
            const [gravity, setGravity] = useState(9.8);
            const [friction, setFriction] = useState(0.0);
            const [slowMo, setSlowMo] = useState(false);
            const [isPaused, setIsPaused] = useState(false);

            // Interaction state
            const [isDragging, setIsDragging] = useState(false);

            // Physics state (Refs for performance)
            const physics = useRef({
                angle: Math.PI / 4, // Start at 45 degrees
                velocity: 0,        // Angular velocity (rad/s)
                accel: 0
            });

            // UI Update trigger
            const [tick, setTick] = useState(0);
            const reqRef = useRef();
            const svgRef = useRef();

            // --- PHYSICS ENGINE ---
            const updatePhysics = () => {
                if (isDragging || isPaused) return;

                const p = physics.current;
                
                // Sub-stepping for stability (perform 4 calculations per frame)
                const steps = 4;
                const timeScale = slowMo ? 0.2 : 1.0;
                const subDt = (DT * timeScale) / steps;

                for (let i = 0; i < steps; i++) {
                    // Angular Acceleration: alpha = -(g/L) * sin(theta)
                    // Damping is applied to velocity
                    const forceGravity = -gravity / length * Math.sin(p.angle);
                    p.accel = forceGravity;

                    // Semi-implicit Euler integration
                    p.velocity += p.accel * subDt;
                    p.velocity *= (1 - friction * subDt); // Simple damping
                    p.angle += p.velocity * subDt;
                }
            };

            // --- ANIMATION LOOP ---
            useEffect(() => {
                const loop = () => {
                    updatePhysics();
                    setTick(t => t + 1); // Force React render
                    reqRef.current = requestAnimationFrame(loop);
                };
                reqRef.current = requestAnimationFrame(loop);
                return () => cancelAnimationFrame(reqRef.current);
            }, [isDragging, isPaused, length, mass, gravity, friction, slowMo]);

            // --- INTERACTION HANDLERS ---
            const getAngleFromEvent = (e) => {
                if (!svgRef.current) return 0;
                const rect = svgRef.current.getBoundingClientRect();
                
                // Center of SVG is the pivot (because of viewBox setup)
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + (rect.height * 0.2); // Pivot is at y=0 in SVG, which is 20% down in viewBox

                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                // Calculate angle relative to vertical (positive Y is down)
                const dx = clientX - centerX;
                const dy = clientY - centerY;
                
                // Math.atan2(y, x) gives angle from X axis. 
                // We want angle from Y axis (vertical). 
                // So we use atan2(x, y).
                return Math.atan2(dx, dy);
            };

            const startDrag = (e) => {
                setIsDragging(true);
                const newAngle = getAngleFromEvent(e);
                physics.current.angle = newAngle;
                physics.current.velocity = 0; // Reset velocity on grab
            };

            const onDrag = (e) => {
                if (!isDragging) return;
                const newAngle = getAngleFromEvent(e);
                physics.current.angle = newAngle;
                physics.current.velocity = 0;
            };

            const endDrag = () => {
                setIsDragging(false);
            };

            // --- CALCULATIONS FOR RENDER ---
            const p = physics.current;
            
            // Position
            const bobX = Math.sin(p.angle) * length * PIXELS_PER_METER;
            const bobY = Math.cos(p.angle) * length * PIXELS_PER_METER;

            // Energy Calculations
            // h = L - Lcos(theta) (Height relative to lowest point)
            const h = length * (1 - Math.cos(p.angle));
            
            // Tangential velocity v = r * omega
            const v = length * p.velocity;

            const pe = mass * gravity * h;
            const ke = 0.5 * mass * v * v;
            const totalEnergy = pe + ke;

            // Max energy for scaling bars (prevent jittering bars by using a smoothed max or fixed max based on start)
            // For this demo, we'll scale based on current Total to fill the bar, or a fixed reasonable max
            const maxDisplayEnergy = Math.max(totalEnergy, 1); 

            return (
                <div className="h-screen w-screen bg-slate-900 text-slate-100 flex flex-col md:flex-row overflow-hidden font-sans no-select">
                    
                    {/* LEFT: SIMULATION VIEW */}
                    <div className="relative flex-grow h-1/2 md:h-full bg-slate-950 border-b md:border-b-0 md:border-r border-slate-800">
                        
                        {/* Overlay Controls */}
                        <div className="absolute top-4 left-4 z-10 flex gap-2">
                             <button 
                                onClick={() => setIsPaused(!isPaused)}
                                className="p-2 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg text-white transition-colors"
                            >
                                {isPaused ? <Play size={20} fill="currentColor" /> : <Pause size={20} fill="currentColor" />}
                            </button>
                            <button 
                                onClick={() => {
                                    physics.current = { angle: 0, velocity: 0, accel: 0 };
                                    setTick(t => t+1);
                                }}
                                className="p-2 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg text-white transition-colors"
                            >
                                <RotateCcw size={20} />
                            </button>
                        </div>

                        <div className="absolute top-4 right-4 z-10 text-right opacity-60 pointer-events-none">
                            <h1 className="text-xl font-bold tracking-tight">Simple Pendulum</h1>
                            <p className="text-xs text-slate-400">Drag bob to release</p>
                        </div>

                        {/* Interactive Area */}
                        <div 
                            className="w-full h-full cursor-grab active:cursor-grabbing touch-none"
                            onMouseDown={startDrag}
                            onMouseMove={onDrag}
                            onMouseUp={endDrag}
                            onMouseLeave={endDrag}
                            onTouchStart={startDrag}
                            onTouchMove={onDrag}
                            onTouchEnd={endDrag}
                        >
                            <svg ref={svgRef} viewBox="-300 -50 600 500" className="w-full h-full" preserveAspectRatio="xMidYMin meet">
                                {/* Ceiling / Pivot Support */}
                                <line x1="-100" y1="0" x2="100" y2="0" stroke="#475569" strokeWidth="4" strokeLinecap="round" />
                                <circle cx="0" cy="0" r="6" fill="#94a3b8" />

                                {/* Reference Line (Vertical) */}
                                <line x1="0" y1="0" x2="0" y2="400" stroke="#334155" strokeWidth="2" strokeDasharray="5,5" />

                                {/* The Pendulum String */}
                                <line 
                                    x1="0" y1="0" 
                                    x2={bobX} y2={bobY} 
                                    stroke="#cbd5e1" 
                                    strokeWidth="3" 
                                />

                                {/* The Bob */}
                                <g transform={`translate(${bobX}, ${bobY})`}>
                                    <circle r={20 + (mass * 2)} fill="#38bdf8" stroke="white" strokeWidth="2" className="shadow-lg" />
                                    {/* Velocity Vector */}
                                    <line 
                                        x1="0" y1="0" 
                                        x2={Math.cos(p.angle) * v * 10} 
                                        y2={-Math.sin(p.angle) * v * 10} 
                                        stroke="#10b981" strokeWidth="3" opacity="0.8"
                                    />
                                </g>

                                {/* Angle Arc */}
                                <path 
                                    d={`M 0 60 A 60 60 0 0 ${p.angle < 0 ? 0 : 1} ${Math.sin(p.angle)*60} ${Math.cos(p.angle)*60}`}
                                    fill="none" stroke="#64748b" strokeWidth="2" opacity="0.5"
                                />
                            </svg>
                        </div>
                    </div>

                    {/* RIGHT: DATA & CONTROLS */}
                    <div className="w-full md:w-96 bg-slate-900 flex flex-col border-l border-slate-800 overflow-y-auto">
                        
                        {/* 1. Energy Visualization */}
                        <div className="p-6 border-b border-slate-800 bg-slate-800/30">
                            <div className="flex items-center gap-2 mb-6 text-slate-400 uppercase text-xs font-bold tracking-wider">
                                <Zap size={16} /> Energy Conversion
                            </div>

                            <div className="flex flex-col gap-6">
                                {/* Combined Bar */}
                                <div className="flex h-64 w-full gap-4 items-end justify-center">
                                    {/* PE Bar */}
                                    <div className="w-16 bg-slate-800 rounded-t-lg relative group">
                                        <div 
                                            className="absolute bottom-0 w-full bg-blue-500 rounded-t-lg transition-all duration-75 flex items-end justify-center"
                                            style={{ height: `${(pe / Math.max(0.1, totalEnergy)) * 100}%` }}
                                        >
                                            <span className="text-xs font-bold text-white mb-2 drop-shadow-md">PE</span>
                                        </div>
                                        <div className="absolute -top-6 w-full text-center text-xs text-blue-400 font-mono">
                                            {pe.toFixed(1)}J
                                        </div>
                                    </div>

                                    {/* KE Bar */}
                                    <div className="w-16 bg-slate-800 rounded-t-lg relative group">
                                        <div 
                                            className="absolute bottom-0 w-full bg-emerald-500 rounded-t-lg transition-all duration-75 flex items-end justify-center"
                                            style={{ height: `${(ke / Math.max(0.1, totalEnergy)) * 100}%` }}
                                        >
                                            <span className="text-xs font-bold text-white mb-2 drop-shadow-md">KE</span>
                                        </div>
                                        <div className="absolute -top-6 w-full text-center text-xs text-emerald-400 font-mono">
                                            {ke.toFixed(1)}J
                                        </div>
                                    </div>

                                    {/* Total Bar (Reference) */}
                                    <div className="w-8 bg-slate-800 rounded-t-lg relative opacity-50 border border-slate-600 border-dashed">
                                        <div className="absolute bottom-0 w-full h-full flex items-end justify-center">
                                        </div>
                                        <div className="absolute -top-6 w-full text-center text-xs text-slate-400 font-mono">
                                            Tot
                                        </div>
                                    </div>
                                </div>
                                <div className="text-center text-xs text-slate-500">
                                    Total Energy: {totalEnergy.toFixed(2)} J
                                </div>
                            </div>
                        </div>

                        {/* 2. Controls */}
                        <div className="p-6 space-y-8 flex-grow">
                            <div className="flex items-center gap-2 text-slate-400 uppercase text-xs font-bold tracking-wider">
                                <Gauge size={16} /> Parameters
                            </div>

                            <InputSlider 
                                label="String Length" 
                                value={length} 
                                set={setLength} 
                                min={0.5} max={2.0} step={0.1} unit="m" 
                            />
                            
                            <InputSlider 
                                label="Bob Mass" 
                                value={mass} 
                                set={setMass} 
                                min={0.5} max={10.0} step={0.5} unit="kg" 
                            />
                            
                            <InputSlider 
                                label="Gravity" 
                                value={gravity} 
                                set={setGravity} 
                                min={1.6} max={20.0} step={0.1} unit="m/sÂ²" 
                            />

                            <InputSlider 
                                label="Friction (Air Resistance)" 
                                value={friction} 
                                set={setFriction} 
                                min={0.0} max={0.5} step={0.01} unit="" 
                            />

                            <button 
                                onClick={() => setSlowMo(!slowMo)}
                                className={`w-full py-3 rounded-lg font-medium border transition-colors ${slowMo ? 'bg-indigo-600 border-indigo-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-300 hover:bg-slate-700'}`}
                            >
                                {slowMo ? "Slow Motion: ON" : "Slow Motion: OFF"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Helper Component for Sliders
        const InputSlider = ({ label, value, set, min, max, step, unit }) => (
            <div>
                <div className="flex justify-between mb-2 text-sm">
                    <span className="text-slate-300">{label}</span>
                    <span className="text-sky-400 font-mono">{value.toFixed(2)} {unit}</span>
                </div>
                <input 
                    type="range" min={min} max={max} step={step} value={value}
                    onChange={e => set(parseFloat(e.target.value))}
                    className="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-sky-500"
                />
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>